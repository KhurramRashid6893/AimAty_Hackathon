<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard â€” Bharat Votes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&family=Noto+Serif+Devanagari:wght@500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --saffron: #FF9933;
      --white: #FFFFFF;
      --green: #138808;
      --navy: #000080;
      --light-blue: #E6F0FF;
      --light-green: #E6FFE6;
      --light-saffron: #FFF0E0;
      --dark-blue: #1E3A8A;
    }
    
    body {
      font-family: 'Hind Siliguri', sans-serif;
      background-color: #f8fafc;
    }
    
    .brand-font {
      font-family: 'Noto Serif Devanagari', serif;
    }
    
    .header-gradient {
      background: linear-gradient(135deg, var(--saffron) 0%, var(--green) 100%);
    }
    
    .footer-gradient {
      background: linear-gradient(135deg, var(--light-saffron) 0%, var(--light-green) 100%);
      border-top: 2px solid var(--green);
    }
    
    .ashoka-wheel {
      width: 40px;
      height: 40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 22c-5.514 0-10-4.486-10-10S6.486 2 12 2s10 4.486 10 10-4.486 10-10 10zm4.5-12.5c0 .828-.672 1.5-1.5 1.5s-1.5-.672-1.5-1.5.672-1.5 1.5-1.5 1.5.672 1.5 1.5zm-9 0c0 .828-.672 1.5-1.5 1.5s-1.5-.672-1.5-1.5.672-1.5 1.5-1.5 1.5.672 1.5 1.5zm9.5 4.5h-9c-.828 0-1.5-.672-1.5-1.5s.672-1.5 1.5-1.5h9c.828 0 1.5.672 1.5 1.5s-.672 1.5-1.5 1.5z' fill='%23FFFFFF'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
    }
    
    .ashoka-wheel-small {
      width: 24px;
      height: 24px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 22c-5.514 0-10-4.486-10-10S6.486 2 12 2s10 4.486 10 10-4.486 10-10 10zm4.5-12.5c0 .828-.672 1.5-1.5 1.5s-1.5-.672-1.5-1.5.672-1.5 1.5-1.5 1.5.672 1.5 1.5zm-9 0c0 .828-.672 1.5-1.5 1.5s-1.5-.672-1.5-1.5.672-1.5 1.5-1.5 1.5.672 1.5 1.5zm9.5 4.5h-9c-.828 0-1.5-.672-1.5-1.5s.672-1.5 1.5-1.5h9c.828 0 1.5.672 1.5 1.5s-.672 1.5-1.5 1.5z' fill='%23000'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
    }
    
    .header-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .header-btn-login {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .header-btn-login:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .header-btn-signup {
      background-color: white;
      color: var(--green);
    }
    
    .header-btn-signup:hover {
      background-color: var(--light-green);
    }
    
    .flash-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
    }
    
    .flash-success {
      background-color: #D1FAE5;
      color: #065F46;
      border-left: 4px solid #10B981;
    }
    
    .flash-danger {
      background-color: #FEE2E2;
      color: #B91C1C;
      border-left: 4px solid #EF4444;
    }
    
    .flash-info {
      background-color: #DBEAFE;
      color: #1E40AF;
      border-left: 4px solid #3B82F6;
    }
    
    .dashboard-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #E5E7EB;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 20px;
      border: 1px solid #E5E7EB;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--dark-blue);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #6B7280;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    .data-table th {
      background-color: #F9FAFB;
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #E5E7EB;
    }
    
    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #E5E7EB;
      color: #4B5563;
    }
    
    .data-table tr:hover {
      background-color: #F9FAFB;
    }
    
    .form-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--saffron);
      box-shadow: 0 0 0 3px rgba(255, 153, 51, 0.2);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--saffron) 0%, var(--green) 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }
    
    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .activity-item {
      padding: 12px 16px;
      border-left: 4px solid var(--saffron);
      background: white;
      margin-bottom: 8px;
      border-radius: 0 8px 8px 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .activity-vote {
      border-left-color: var(--green);
    }
    
    .activity-ballot {
      border-left-color: var(--saffron);
    }
    
    .activity-new {
      border-left-color: #3B82F6;
    }
    
    .activity-mismatch {
      border-left-color: #EF4444;
    }
    
    .chart-container {
      position: relative;
      height: 250px;
      width: 100%;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50 relative">

  <header class="header-gradient shadow-lg p-4 flex justify-between items-center sticky top-0 z-50">
    <div class="flex items-center space-x-4">
      <div class="flex items-center">
        <div class="ashoka-wheel mr-3"></div>
        <h1 class="text-3xl font-bold text-white brand-font drop-shadow-md">Bharat Votes</h1>
      </div>
      <div class="hidden md:block text-white text-sm">
        <p>Empowering Democracy Through Technology</p>
      </div>
    </div>
    <nav class="flex items-center space-x-4">
      <a href="{{ url_for('main.login') }}" class="header-btn header-btn-login">
        <i class="fas fa-sign-in-alt mr-2"></i>Login
      </a>
      <a href="{{ url_for('main.signup') }}" class="header-btn header-btn-signup">
        <i class="fas fa-user-plus mr-2"></i>Sign Up
      </a>
    </nav>
  </header>

  <div class="container mx-auto mt-4 px-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2">
          {% for category, message in messages %}
            <div class="flash-message flash-{{ category }}">
              <i class="fas {% if category=='success' %}fa-check-circle{% elif category=='danger' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} mr-2"></i>
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
  </div>

  <main id="main-content" class="flex-grow container mx-auto px-4 py-8">
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2>
        <div class="text-sm text-gray-500">
          <i class="fas fa-shield-alt mr-1"></i> Administrator Access
        </div>
      </div>
      
      <!-- Stats Overview -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stat-card">
          <div class="stat-icon bg-blue-100 text-blue-600">
            <i class="fas fa-vote-yea text-xl"></i>
          </div>
          <div class="stat-value">{{ total_votes }}</div>
          <div class="stat-label">Total Votes Cast</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon bg-green-100 text-green-600">
            <i class="fas fa-users text-xl"></i>
          </div>
          <div class="stat-value">{{ candidate_results|length }}</div>
          <div class="stat-label">Candidates</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon bg-purple-100 text-purple-600">
            <i class="fas fa-flag text-xl"></i>
          </div>
          <div class="stat-value">{{ party_tally|length }}</div>
          <div class="stat-label">Political Parties</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon bg-amber-100 text-amber-600">
            <i class="fas fa-map-marker-alt text-xl"></i>
          </div>
          <div class="stat-value">{{ constituency_tally|length }}</div>
          <div class="stat-label">Constituencies</div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Candidate Tally -->
        <div class="dashboard-card">
          <h3 class="text-xl font-semibold text-gray-800 mb-6 pb-2 border-b">Candidate Tally</h3>
          <div class="chart-container">
            <canvas id="candidateChart"></canvas>
          </div>
          <div class="mt-4 overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Candidate</th>
                  <th>Votes</th>
                </tr>
              </thead>
              <tbody>
                {% for row in candidate_results %}
                <tr>
                  <td>{{ row.candidate.name if row.candidate else row.candidate_id }}</td>
                  <td>{{ row.count }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Party Tally -->
        <div class="dashboard-card">
          <h3 class="text-xl font-semibold text-gray-800 mb-6 pb-2 border-b">Party Tally</h3>
          <div class="chart-container">
            <canvas id="partyChart"></canvas>
          </div>
          <div class="mt-4 overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Party</th>
                  <th>Votes</th>
                </tr>
              </thead>
              <tbody>
                {% for p,c in party_tally %}
                <tr>
                  <td>{{ p }}</td>
                  <td>{{ c }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Constituency Tally -->
      <div class="dashboard-card mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-6 pb-2 border-b">Constituency Tally</h3>
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Constituency</th>
                <th>Votes</th>
              </tr>
            </thead>
            <tbody>
              {% for con,c in constituency_tally %}
              <tr>
                <td>{{ con }}</td>
                <td>{{ c }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Manual Trigger -->
        <div class="dashboard-card">
          <h3 class="text-xl font-semibold text-gray-800 mb-6 pb-2 border-b">Manual Ballot Activation</h3>
          <p class="text-gray-600 mb-4">Enter Aadhaar + VoterID to activate ballot remotely:</p>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Aadhaar Number</label>
              <input type="text" id="ajax_aadhaar" placeholder="Aadhaar" class="form-input" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Voter ID</label>
              <input type="text" id="ajax_vid" placeholder="Voter ID" class="form-input" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Booth Number</label>
              <input type="text" id="ajax_booth" placeholder="Booth" value="B1" class="form-input" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Note (Optional)</label>
              <input type="text" id="ajax_note" placeholder="Note" class="form-input" />
            </div>
            
            <button id="ajax_trigger_btn" class="btn-primary w-full">
              <i class="fas fa-bolt mr-2"></i>Activate Ballot
            </button>
            
            <div id="ajax_trigger_res" class="p-3 bg-gray-100 rounded-lg text-sm mt-4"></div>
          </div>
        </div>
        
        <!-- Live Activity Feed -->
        <div class="dashboard-card">
          <h3 class="text-xl font-semibold text-gray-800 mb-6 pb-2 border-b">Live Activity Feed</h3>
          <div id="activityFeed" class="h-96 overflow-y-auto space-y-3">
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-circle-notch fa-spin mr-2"></i> Loading activities...
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer-gradient text-gray-800 py-6 mt-8 text-center">
    <div class="container mx-auto px-4">
      <div class="flex justify-center items-center mb-4">
        <div class="ashoka-wheel-small mr-2"></div>
        <p class="font-bold">Bharat Votes</p>
      </div>
      <p class="text-sm">&copy; 2025 Next Gen Voting. All rights reserved.</p>
      <p class="text-xs mt-2">Empowering Indian Democracy Through Secure Digital Voting</p>
    </div>
  </footer>

  <script>
    document.getElementById('ajax_trigger_btn').addEventListener('click', async ()=>{
      const aadhaar = document.getElementById('ajax_aadhaar').value.trim();
      const voter_id = document.getElementById('ajax_vid').value.trim();
      const booth = document.getElementById('ajax_booth').value.trim() || 'B1';
      const note = document.getElementById('ajax_note').value.trim();
      if(!aadhaar || !voter_id){ alert('Enter both Aadhaar and Voter ID'); return; }
      
      const resultEl = document.getElementById('ajax_trigger_res');
      resultEl.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i> Processing...</div>';
      
      const resp = await fetch('/api/manual_override',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({aadhaar,voter_id,booth_number:booth,note})
      });
      const j = await resp.json();
      
      if(resp.ok) {
        resultEl.innerHTML = `<div class="text-green-600"><i class="fas fa-check-circle mr-2"></i> ${j.message || 'Ballot activated successfully'}</div>`;
      } else {
        resultEl.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-circle mr-2"></i> ${j.message || 'Error activating ballot'}</div>`;
      }
    });

    async function pollFeed(){
      try{
        const resp = await fetch('/api/activity_feed');
        const data = await resp.json();
        const feed = document.getElementById('activityFeed');
        feed.innerHTML = '';
        
        if(data.length === 0) {
          feed.innerHTML = '<div class="text-center py-8 text-gray-500">No recent activities</div>';
          return;
        }
        
        data.forEach(ev=>{
          const div = document.createElement('div');
          div.className = 'activity-item';
          
          if(ev.type==='ballot'){
            div.className += ' activity-ballot';
            div.innerHTML = `<div class="flex justify-between items-start">
              <div><i class="fas fa-vote-yea mr-2 text-amber-500"></i> Ballot <b>${ev.status}</b> for voter <b>${ev.voter_id}</b></div>
              <div class="text-xs text-gray-500">${ev.time}</div>
            </div>
            <div class="text-xs text-gray-600 mt-1">Booth: ${ev.booth}</div>`;
          } else if(ev.type==='vote'){
            div.className += ' activity-vote';
            div.innerHTML = `<div class="flex justify-between items-start">
              <div><i class="fas fa-check-circle mr-2 text-green-500"></i> Vote cast by <b>${ev.voter_id}</b> for candidate <b>${ev.candidate_id}</b></div>
              <div class="text-xs text-gray-500">${ev.time}</div>
            </div>
            <div class="text-xs text-gray-600 mt-1">Receipt: ${ev.receipt} | Booth: ${ev.booth}</div>`;
          } else if(ev.type==='new_voter'){
            div.className += ' activity-new';
            div.innerHTML = `<div class="flex justify-between items-start">
              <div><i class="fas fa-user-plus mr-2 text-blue-500"></i> New voter <b>${ev.voter_id}</b> registered</div>
              <div class="text-xs text-gray-500">${ev.time}</div>
            </div>
            <div class="text-xs text-gray-600 mt-1">Aadhaar: ${ev.aadhaar} (via ${ev.note})</div>`;
          } else if(ev.type==='mismatch'){
            div.className += ' activity-mismatch';
            div.innerHTML = `<div class="flex justify-between items-start">
              <div><i class="fas fa-exclamation-triangle mr-2 text-red-500"></i> Mismatch logged for Aadhaar <b>${ev.aadhaar}</b></div>
              <div class="text-xs text-gray-500">${ev.time}</div>
            </div>
            <div class="text-xs text-gray-600 mt-1">Voter ID: ${ev.voter_id}</div>`;
          }
          feed.appendChild(div);
        });
      }catch(e){ 
        console.error(e);
        document.getElementById('activityFeed').innerHTML = '<div class="text-red-500">Error loading activity feed</div>';
      }
    }
    
    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
      // Candidate Chart
      const candidateCtx = document.getElementById('candidateChart').getContext('2d');
      const candidateChart = new Chart(candidateCtx, {
        type: 'bar',
        data: {
          labels: [{% for row in candidate_results %}'{{ row.candidate.name if row.candidate else row.candidate_id }}',{% endfor %}],
          datasets: [{
            label: 'Votes',
            data: [{% for row in candidate_results %}{{ row.count }},{% endfor %}],
            backgroundColor: 'rgba(255, 153, 51, 0.7)',
            borderColor: 'rgba(255, 153, 51, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Party Chart
      const partyCtx = document.getElementById('partyChart').getContext('2d');
      const partyChart = new Chart(partyCtx, {
        type: 'doughnut',
        data: {
          labels: [{% for p,c in party_tally %}'{{ p }}',{% endfor %}],
          datasets: [{
            data: [{% for p,c in party_tally %}{{ c }},{% endfor %}],
            backgroundColor: [
              'rgba(255, 153, 51, 0.7)',
              'rgba(19, 136, 8, 0.7)',
              'rgba(30, 58, 138, 0.7)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(239, 68, 68, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(245, 158, 11, 0.7)',
              'rgba(99, 102, 241, 0.7)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    });
    
    // Poll activity feed every 3 seconds
    setInterval(pollFeed, 3000);
    pollFeed();
  </script>
</body>
</html>